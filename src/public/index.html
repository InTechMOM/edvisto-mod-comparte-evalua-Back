<!DOCTYPE HTML>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="Cross-Origin-Opener-Policy" content="same-origin">
    <title>Registro con Google</title>
   </head>
<body>
    <h1>Registro con Google</h1>
    <button type="button" id="googlelogin">Iniciar sesión con Google</button>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>

        <script type="module">

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithCredential } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js';

        const firebaseConfig = {
        apiKey: "AIzaSyBJNkX9GYXk4hJbd4kYzaCw5ppJR0f_vP8",
        authDomain: "team-9-back-asp.firebaseapp.com",
        projectId: "team-9-back-asp",
        storageBucket: "team-9-back-asp.appspot.com",
        messagingSenderId: "760161682996",
        appId: "1:760161682996:web:2b3d170eb0ec89dd222c61"
        };

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // Estoy captando del HTML el nodo del botón (googlelogin)
        const buttonGoogle = document.getElementById("googlelogin");

        let authentication = null;
        let idToken = null;

        // El buttonGoogle escucha el evento del click (evento y funcionalidad)
        buttonGoogle.addEventListener("click", async (event) => {
            try {
                authentication = await signInWithPopup(auth, provider);

                // Después de que el usuario haya sido autenticado con éxito
                if (authentication) {
                    const user = authentication.user;
                    console.log("Usuario autenticado:", user);

                    // Obtener el idToken del usuario
                    const idToken = await user.getIdToken(true);
                    console.log("ID Token del usuario:", idToken);
                                    
                    const requestOptions = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user, idToken }),
                    };

                    fetch('http://localhost:3000/api/registergoogle', requestOptions)
                        .then((response) => {
                            response.json();
                            if (response.status === 200) {
                                console.log('User Authenticated');
                            } else if (response.status === 201) {
                                console.log('User Created and Authenticated');
                            } else if (response.status === 400) {
                                console.log('It was not possible to authenticate the user');
                            } else if (response.status === 500) {
                                console.log('Authentication Error');
                            } else {
                                console.log('La solicitud POST falló con el código de error:', response.status);
                            }
                        })
                        .catch((error) => {
                            console.log(error);
                        });

                } else {
                    console.log("No se logró autenticar al usuario");
                }
            } catch (error) {
                const errorCode = error.code;
                const errorMessage = error.message;
                console.error("Error de autenticación:", errorCode, errorMessage);
            }
        });
    </script>
</body>
</html>